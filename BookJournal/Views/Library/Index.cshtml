@model IEnumerable<BookDTO>
@{
    ViewData["Title"] = "Library";
}

<div class="fade-in">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="bi bi-collection text-primary me-2"></i>Your Library
            </h1>
            <p class="text-muted">Manage and explore your book collection</p>
        </div>
        <a asp-controller="Book" asp-action="Create" class="btn btn-primary d-flex align-items-center">
            <i class="bi bi-plus-circle me-2"></i>Add New Book
        </a>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th><i class="bi bi-book me-2"></i>Title</th>
                            <th><i class="bi bi-person me-2"></i>Author</th>
                            <th><i class="bi bi-building me-2"></i>Publisher</th>
                            <th><i class="bi bi-tags me-2"></i>Genres</th>
                            <th class="text-end"><i class="bi bi-gear me-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var book in Model)
                        {
                            <tr>
                                <td class="align-middle">@book.Title</td>
                                <td class="align-middle">@book.Author</td>
                                <td class="align-middle">@book.Publisher</td>
                                <td class="align-middle">
                                    @foreach (var genre in book.Genres)
                                    {
                                        <span class="badge bg-secondary bg-opacity-10 text-secondary me-1">@genre</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <div class="mt-auto">
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-success btn-sm add-to-journal-btn flex-fill" 
                                                    data-bs-toggle="modal" data-bs-target="#addBookToJournalModal" 
                                                    data-book-id="@book.Id" data-book-title="@book.Title"
                                                    title="Add to Journal">
                                                <i class="bi bi-journal-plus me-1"></i>Add to Journal
                                            </button>
                                        </div>
                                        <div class="btn-group w-100 mt-2" role="group">
                                            <a asp-controller="Book" asp-action="Edit" asp-route-id="@book.Id" 
                                            class="btn btn-sm btn-outline-primary flex-fill" 
                                            data-bs-toggle="tooltip" title="Edit Book">
                                                <i class="bi bi-pencil me-1"></i>Edit
                                            </a>
                                            <form asp-controller="Book" asp-action="Delete" asp-route-id="@book.Id" 
                                                method="post" class="d-inline" 
                                                onsubmit="return confirm('Are you sure? This will also delete all user progress for this book.');">
                                                <button type="submit" class="btn btn-outline-danger btn-sm delete-book-btn  flex-fill" 
                                                        data-bs-toggle="tooltip" title="Delete Book">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_CreateProgressTrackerModal", new ProgressTrackerCreateDTO())

@section Scripts {
    <script>
        $(document).ready(function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            $('.delete-btn').hover(
                function() {
                    $(this).removeClass('btn-outline-danger').addClass('btn-danger');
                },
                function() {
                    $(this).removeClass('btn-danger').addClass('btn-outline-danger');
                }
            );

            $('.add-to-journal-btn').click(function () {
                var button = $(this);
                var modal = $('#addBookToJournalModal');
                modal.find('#addBookForm #BookId').val(button.data('book-id'));
                modal.find('.modal-title').text('Add "' + button.data('book-title') + '" to your journal');
            });

            $('[data-bs-toggle="tooltip"]').tooltip();

            $('.alert').addClass('fade-in');
        });
    </script>
}